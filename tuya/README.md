# Tuya Monitor â€” FreeBSD

This repository contains a Python 3 script for monitoring a Tuya-connected device. The monitor automatically detects online/offline status, sends Telegram notifications, and can enable or disable other Tuya devices depending on the monitored device's state. It is designed to run as a daemon on FreeBSD.

---

## Files Overview

| File | Description |
|------|------------|
| `tuya_monitor.py` | Main Python script. Monitors a Tuya device, logs heartbeat, triggers Telegram notifications, and enables/disables other devices. |
| `tuya_monitor.txt` | Environment variable definitions for the monitor. **Variable names must not be changed.** |
| `run_tuya_monitor.sh` | Wrapper shell script for running the monitor as a FreeBSD daemon. Handles lock files and log output. |
| `tuya_monitor.log` | Log file generated by the monitor containing heartbeat, errors, and Telegram events. |

---

## Configuration

### Environment Variables (`tuya_monitor.txt`)

Define the following variables in your `tuya_monitor.txt` file:

```sh
# Telegram configuration
export TELEGRAM_TOKEN="..."         # Bot token
export TELEGRAM_CHAT_ID="..."       # Chat ID for notifications

# Tuya API configuration
export TUYA_ACCESS_ID="..."
export TUYA_ACCESS_KEY="..."
export TUYA_REGION="eu"             # Tuya region: eu, us, cn, etc.

# Device monitoring
export TUYA_DEVICE_ID="..."         # Device to monitor

# Comma-separated list of devices to disable/enable
export DISABLE_DEVICE_IDS="device1,device2,..."

# Monitoring parameters
export INTERVAL="10"                # Seconds between checks
export JITTER="2"                   # Random jitter to avoid polling collisions
export CONFIRM_SECONDS="60"         # Seconds to confirm a status change
```

### How to Obtain Credentials and Device IDs

#### 1. Telegram Bot Token and Chat ID
1.  Create a new bot via **BotFather** in Telegram.
2.  Use the `/newbot` command to create a bot and receive your `TELEGRAM_TOKEN`.
3.  To get the chat ID, send a message to your new bot, then visit the following URL (replace `<TELEGRAM_TOKEN>` with your actual token):
    
    ```
    [https://api.telegram.org/bot](https://api.telegram.org/bot)<TELEGRAM_TOKEN>/getUpdates
    ```

4.  The returned JSON contains the `chat_id`.

#### 2. Tuya API Credentials
1.  Go to the [Tuya IoT Cloud Platform](https://iot.tuya.com/).
2.  Create a new **Project** under Project Management.
3.  Link your existing Tuya account via the **"Link App Account"** option.
4.  Navigate to **Project Settings** to find your `TUYA_ACCESS_ID`, `TUYA_ACCESS_KEY`, and `TUYA_REGION`.

#### 3. Device IDs
1.  After linking your account in the Tuya IoT Console, navigate to **All Devices**.
2.  Each device lists a **Device ID**.
3.  Note down the `TUYA_DEVICE_ID` for the device you want to monitor.
4.  Any other devices you want to control based on the monitor's status should be added to `DISABLE_DEVICE_IDS`.

---

## Main Script Logic

The `tuya_monitor.py` script runs continuously and performs the following steps:

### Tuya API Token Management
* Automatically refreshes the access token when expired.
* Signs all requests with **HMAC-SHA256** as required by the Tuya API.

### Heartbeat Monitoring
* Checks the online status of the monitored device (`TUYA_DEVICE_ID`) at intervals defined by `INTERVAL` plus a random `JITTER`.
* **Randomized Interval:** Adds random jitter to the check interval (`INTERVAL` + `random(0,JITTER)`) to avoid synchronized API calls if multiple monitors are running.
* Only logs a single heartbeat message per online/offline state to avoid excessive log entries.

### State Change Detection
When a change in the monitored device's online status is detected:
1.  Starts a confirmation window of `CONFIRM_SECONDS` to avoid false triggers from transient network glitches.
2.  Re-checks the device after the confirmation period.
3.  **If confirmed:**
    * Sends a Telegram notification.
    * Sets `switch_1=false` for each device in `DISABLE_DEVICE_IDS` when the monitor goes **offline**.
    * Sets `switch_1=true` for each device in `DISABLE_DEVICE_IDS` and also re-enables the monitored device itself when it comes back **online**.

### Logging
* Errors (API failures, exceptions) are logged separately.
* Token refresh events and Telegram notifications are logged.
* Telegram messages indicate whether the monitor is `ONLINE` or `OFFLINE` and which devices were disabled/enabled.

---

## Example Log Output

```json
{"ts":"2026-01-26 01:34:47,948","level":"INFO","event":{"event": "monitor_started"}}
{"ts":"2026-01-26 01:34:47,948","level":"INFO","event":{"event": "tuya_token_refreshed"}}
{"ts":"2026-01-26 01:34:47,948","level":"INFO","event":{"event": "heartbeat", "online": true}}
{"ts":"2026-01-26 01:37:44,000","level":"INFO","event":{"event": "telegram_sent"}}
{"ts":"2026-01-26 01:38:12,500","level":"INFO","event":{"event": "heartbeat", "online": false}}
{"ts":"2026-01-26 01:38:12,500","level":"INFO","event":{"event": "telegram_sent"}}
{"ts":"2026-01-26 01:38:12,500","level":"ERROR","event":{"event": "monitor_error", "error": "online_field_missing"}}
```
