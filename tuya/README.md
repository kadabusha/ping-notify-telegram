# Tuya Monitor â€” FreeBSD

This repository contains a Python 3 script for monitoring a Tuya-connected device. The monitor detects online/offline status using ICMP ping first (with Tuya API fallback), sends Telegram notifications, and can enable or disable other Tuya devices depending on the monitored device's state. It is designed to run as a daemon on FreeBSD.

---

## Files Overview

| File | Description |
|------|------------|
| `tuya_monitor.py` | Main Python script. Monitors a Tuya device with ping-first detection, logs heartbeat, triggers Telegram notifications, and enables/disables other devices. |
| `tuya_monitor.txt` | Environment variable definitions for the monitor. **Variable names must not be changed.** |
| `run_tuya_monitor.sh` | Wrapper shell script for running the monitor as a FreeBSD daemon. Handles lock files and log output. |
| `tuya_monitor.log` | Log file generated by the monitor containing heartbeat, errors, and Telegram events. |

---

## Configuration

### Environment Variables (`tuya_monitor.txt`)

Define the following variables in your `tuya_monitor.txt` file:

```sh
# Telegram configuration
export TELEGRAM_TOKEN="..."         # Bot token
export TELEGRAM_CHAT_ID="..."       # Chat ID for notifications

# Tuya API configuration
export TUYA_ACCESS_ID="..."
export TUYA_ACCESS_KEY="..."
export TUYA_REGION="eu"             # Tuya region: eu, us, cn, etc.

# Device monitoring
export TUYA_DEVICE_ID="..."         # Device to monitor

# Comma-separated list of devices to disable/enable
export DISABLE_DEVICE_IDS="device1,device2,..."

# Monitoring parameters (legacy; currently unused by the script)
export INTERVAL="60"
export JITTER="2"

# Ping parameters (primary detection)
export PING_TARGET_HOST="192.168.2.3"  # Host to ping for primary status
export PING_INTERVAL="10"              # Seconds between ping loops
export PING_CONFIRM_COUNT="10"         # Packets in confirm ping burst
export API_OFFLINE_INTERVAL="300"      # Seconds between API safety checks while offline

# Optional debug Telegram channel
export TELEGRAM_CHAT_ID_DEBUG="..."    # If set, duplicates alerts and sends errors
```

### How to Obtain Credentials and Device IDs

#### 1. Telegram Bot Token and Chat ID
1.  Create a new bot via **BotFather** in Telegram.
2.  Use the `/newbot` command to create a bot and receive your `TELEGRAM_TOKEN`.
3.  To get the chat ID, send a message to your new bot, then visit the following URL (replace `<TELEGRAM_TOKEN>` with your actual token):
    
    ```
    [https://api.telegram.org/bot](https://api.telegram.org/bot)<TELEGRAM_TOKEN>/getUpdates
    ```

4.  The returned JSON contains the `chat_id`.

#### 2. Tuya API Credentials
1.  Go to the [Tuya IoT Cloud Platform](https://iot.tuya.com/).
2.  Create a new **Project** under Project Management.
3.  Link your existing Tuya account via the **"Link App Account"** option.
4.  Navigate to **Project Settings** to find your `TUYA_ACCESS_ID`, `TUYA_ACCESS_KEY`, and `TUYA_REGION`.

#### 3. Device IDs
1.  After linking your account in the Tuya IoT Console, navigate to **All Devices**.
2.  Each device lists a **Device ID**.
3.  Note down the `TUYA_DEVICE_ID` for the device you want to monitor.
4.  Any other devices you want to control based on the monitor's status should be added to `DISABLE_DEVICE_IDS`.

---

## Main Script Logic

The `tuya_monitor.py` script runs continuously and performs the following steps:

### Tuya API Token Management
* Automatically refreshes the access token when expired.
* Signs all requests with **HMAC-SHA256** as required by the Tuya API.

### Heartbeat Monitoring
* **Ping-first:** If `PING_TARGET_HOST` is set, the monitor runs a single ping each loop. If the single ping fails and the last known state was online/unknown, it runs a confirm burst (`PING_CONFIRM_COUNT`) to reduce false negatives.
* **API fallback:** If ping is unavailable or confirm ping cannot run, it falls back to Tuya API status checks.
* **Offline safety check:** While offline, it re-checks the Tuya API every `API_OFFLINE_INTERVAL` seconds to avoid being stuck on a false-offline state.
* Logs a heartbeat each loop with the current decision and source.

### State Change Detection
When a change in the monitored device's online status is detected:
1.  **If offline:**
    * Sends a Telegram notification.
    * Sets `switch_1=false` for each device in `DISABLE_DEVICE_IDS`.
2.  **If online:**
    * Sends a Telegram notification.
    * Sets `switch_1=true` for each device in `DISABLE_DEVICE_IDS`.
    * Re-enables the monitored device itself (`TUYA_DEVICE_ID`) with `switch_1=true`.

### Logging
* Errors (API failures, exceptions) are logged separately.
* Token refresh events and API calls are logged.
* Telegram messages indicate whether power is `ONLINE` or `OFFLINE`.

---

## Example Log Output

```json
{"ts":"2026-01-26 01:34:47,948","level":"INFO","event":{"event": "monitor_started"}}
{"ts":"2026-01-26 01:34:47,948","level":"INFO","event":{"event": "api_call", "service": "telegram"}}
{"ts":"2026-01-26 01:34:48,121","level":"INFO","event":{"event": "probe_ping_once", "host": "192.168.2.3", "result": true}}
{"ts":"2026-01-26 01:34:48,121","level":"INFO","event":{"event": "probe_decision", "source": "ping", "online": true}}
{"ts":"2026-01-26 01:34:48,122","level":"INFO","event":{"event": "heartbeat", "online": true}}
{"ts":"2026-01-26 01:38:12,500","level":"INFO","event":{"event": "probe_ping_confirm_start", "host": "192.168.2.3", "confirm_count": 10}}
{"ts":"2026-01-26 01:38:23,501","level":"INFO","event":{"event": "probe_ping_confirm_result", "host": "192.168.2.3", "online": false}}
{"ts":"2026-01-26 01:38:23,502","level":"INFO","event":{"event": "heartbeat", "online": false}}
{"ts":"2026-01-26 01:38:23,502","level":"ERROR","event":{"event": "monitor_error", "error": "online_field_missing"}}
```
